---
source: "blog"
title: "Configure editing form widgets using PyQGIS"
date: "2019-09-30T21:06:36+0000"
link: "https://gisunchained.wordpress.com/2019/09/30/configure-editing-form-widgets-using-pyqgis/"
draft: "false"
showcase: "planet"
subscribers: ["alexandre_netos_blog"]
author: "Alexandre Neto's blog"
tags: ["sem categoria", "pyqgis", "python", "qgis"]
---

<p><a href="https://sigsemgrilhetas.wordpress.com/2019/09/30/norma-cartografica-no-qgis-alterar-formularios-de-edicao-com-pyqgis/">PT</a> | EN</p>
<p>As I was preparing a QGIS Project to read a database structured according to the new <a href="http://www.dgterritorio.pt/cartografia_e_geodesia/cartografia/normas_e_especificacoes_tecnicas_de_cartografia/">rules and technical specifications for the Portuguese Cartography</a>, I started to configure the editing forms for several layers, so that:</p>
<ol>
<li>Make some fields read-only, like for example an identifier field.</li>
<li>Configure widgets better suited for each field, to help the user and avoid errors. For example, date-time files with a pop-up calendar, and value lists with dropdown selectors.</li>
</ol>
<p>Basically, I wanted something like this:</p>
<p><img alt="Peek 2019-09-30 15-04_2" class="size-full wp-image-1565 aligncenter" height="337" src="https://sigsemgrilhetas.files.wordpress.com/2019/09/peek-2019-09-30-15-04_2.gif" width="541" /></p>
<p>Let me say that, in PostGIS layers, QGIS does a great job in figuring out the best widget to use for each field, as well as the constraints to apply. Which is a great help. Nevertheless, some need some extra configuration.</p>
<p>If I had only a few layers and fields, I would have done them all by hand, but after the 5th layer my personal mantra started to chime in:</p>
<blockquote><p>&#8220;If you are using a computer to perform a repetitive manual task, you are doing it wrong!&#8221;</p></blockquote>
<p>So, I began to think how could I configure the layers and fields more systematically. After some research and trial and error, I came up with the following PyQGIS functions.</p>
<h2>Make a field Read-only</h2>
<p>The identifier field (&#8220;identificador&#8221;) is automatically generated by the database. Therefore, the user shouldn&#8217;t edit it. So I had better make it read only</p>
<p><img alt="Layer Properties - cabo_electrico | Attributes Form_103" class="size-full wp-image-1566 aligncenter" height="425" src="https://sigsemgrilhetas.files.wordpress.com/2019/09/layer-properties-cabo_electrico-attributes-form_103.png" width="1035" /></p>
<p>To make all the identifier fields read-only, I used the following code.</p>
<pre>def field_readonly(layer, fieldname, option = True):
    fields = layer.fields()
    field_idx = fields.indexOf(fieldname)
    if field_idx &gt;= 0:
        form_config = layer.editFormConfig()
        form_config.setReadOnly(field_idx, option)
        layer.setEditFormConfig(form_config)

# Example for the field "identificador"

project = QgsProject.instance()
layers = project.mapLayers() 

for layer in layers.values():
    field_readonly(layer,'identificador')
</pre>
<h2>Set fields with DateTime widget</h2>
<p>The date fields are configured automatically, but the default widget setting only outputs the date, and not date-time, as the rules required.</p>
<p>I started by setting a field in a layer exactly how I wanted, then I tried to figure out how those setting were saved in PyQGIS using the Python console:</p>
<pre>&gt;&gt;&gt;layer = iface.mapCanvas().currentLayer()
&gt;&gt;&gt;layer.fields().indexOf('inicio_objeto')
1
&gt;&gt;&gt;field = layer.fields()[1]
&gt;&gt;&gt;field.editorWidgetSetup().type()
'DateTime'
&gt;&gt;&gt;field.editorWidgetSetup().config()
{'allow_null': True, 'calendar_popup': True, 'display_format': 'yyyy-MM-dd HH:mm:ss', 'field_format': 'yyyy-MM-dd HH:mm:ss', 'field_iso_format': False}
</pre>
<p>Knowing this, I was able to create a function that allows configuring a field in a layer using the exact same settings, and apply it to all layers.</p>
<pre>def field_to_datetime(layer, fieldname):
    config = {'allow_null': True,
              'calendar_popup': True,
              'display_format': 'yyyy-MM-dd HH:mm:ss',
              'field_format': 'yyyy-MM-dd HH:mm:ss',
              'field_iso_format': False}
    type = 'Datetime'
    fields = layer.fields()
    field_idx = fields.indexOf(fieldname)
    if field_idx &gt;= 0:
        widget_setup = QgsEditorWidgetSetup(type,config)
        layer.setEditorWidgetSetup(field_idx, widget_setup)

# Example applied to "inicio_objeto" e "fim_objeto"

for layer in layers.values():
    field_to_datetime(layer,'inicio_objeto')
    field_to_datetime(layer,'fim_objeto')
</pre>
<h2><strong>Setting a field with the Value Relation widget<br />
</strong></h2>
<p>In the data model, many tables have fields that only allow a limited number of values. Those values are referenced to other tables, the <em>Foreign keys</em>.</p>
<p>In these cases, it&#8217;s quite helpful to use a Value Relation widget. To configure fields with it in a programmatic way, it&#8217;s quite similar to the earlier example, where we first neet to set an example and see how it&#8217;s stored, but in this case, each field has a slightly different settings</p>
<p>Luckily, whoever designed the data model, did a favor to us all by giving the same name to the fields and the related tables, making it possible to automatically adapt the settings for each case.</p>
<p>The function stars by gathering all fields in which the name starts with &#8216;valor_&#8217; (value). Then, iterating over those fields, adapts the configuration to use the reference layer that as the same name as the field.</p>
<pre>def field_to_value_relation(layer):
    fields = layer.fields()
    pattern = re.compile(r'^valor_')
    fields_valor = [field for field in fields if pattern.match(field.name())]
    if len(fields_valor) &gt; 0:
        config = {'AllowMulti': False,
                  'AllowNull': True,
                  'FilterExpression': '',
                  'Key': 'identificador',
                  'Layer': '',
                  'NofColumns': 1,
                  'OrderByValue': False,
                  'UseCompleter': False,
                   'Value': 'descricao'}
        for field in fields_valor:
            field_idx = fields.indexOf(field.name())
            if field_idx &gt;= 0:
                print(field)
                try:
                    target_layer = QgsProject.instance().mapLayersByName(field.name())[0]
                    config['Layer'] = target_layer.id()
                    widget_setup = QgsEditorWidgetSetup('ValueRelation',config)
                    layer.setEditorWidgetSetup(field_idx, widget_setup)
                except:
                    pass
            else:
                return False
    else:
        return False
    return True
    
# Correr função em todas as camadas
for layer in layers.values():
    field_to_value_relation(layer)
</pre>
<h2><strong>Conclusion</strong></h2>
<p>In a relatively quick way, I was able to set all the project&#8217;s layers with the widgets I needed.<img alt="Peek 2019-09-30 16-06" class="size-full wp-image-1570 aligncenter" height="613" src="https://sigsemgrilhetas.files.wordpress.com/2019/09/peek-2019-09-30-16-06.gif" width="655" /></p>
<p>This seems to me like the tip of the iceberg. If one has the need, with some search and patience, other configurations can be changed using PyQGIS. Therefore, think twice before embarking in configuring a big project, layer by layer, field by fields.</p>
